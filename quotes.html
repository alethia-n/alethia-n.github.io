<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Citations + Chat Priv√©</title>
<link rel="stylesheet" href="style.css">
<style>
/* Styles sp√©cifiques au chat flottant et sidebar admin */
#sidebar { width:250px; position:absolute; left:0; top:0; bottom:0; border-right:1px solid #ccc; padding:10px; background:#f9f9f9; display:none; overflow-y:auto; }
.userItem { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
.userItem.active { background:#ddd; }
.userItem.newMessage { background-color:#ffd966; font-weight:bold; }
#chatToggle { position:fixed; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; background:#007bff; color:#fff; font-size:24px; text-align:center; line-height:50px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:1000; }
#chatContainer { position:fixed; bottom:80px; right:20px; width:320px; max-height:400px; border:1px solid #ccc; border-radius:8px; background:#fff; display:none; flex-direction:column; z-index:1000; }
#chatHeader { padding:10px; background:#007bff; color:#fff; border-top-left-radius:8px; border-top-right-radius:8px; display:flex; justify-content:space-between; align-items:center; }
#messages { flex:1; overflow-y:auto; padding:10px; border-top:1px solid #ccc; border-bottom:1px solid #ccc; }
.message { margin-bottom:5px; }
#newMessage { padding:8px; width:calc(100% - 16px); margin:5px auto; }
#sendBtn { padding:8px; margin:5px; width:calc(100% - 10px); cursor:pointer; }
#logoutBtn { cursor:pointer; background:#ff4d4d; border:none; color:#fff; padding:5px 10px; border-radius:5px; }
</style>
</head>
<body>

<!-- Formulaire de connexion -->
<div id="loginDiv">
<h2>Connexion / Inscription</h2>
<input type="email" id="email" placeholder="Email" required>
<input type="password" id="password" placeholder="Mot de passe (‚â•6 caract√®res)" required>
<button id="loginBtn">Se connecter</button>
<button id="signupBtn">S‚Äôinscrire</button>
<p id="errorMsg"></p>
</div>

<!-- Page citations + sidebar admin -->
<div id="quotesDiv">
<div id="sidebar">
<h3>Utilisateurs</h3>
<div id="usersList"></div>
</div>

<h2>Citations</h2>
<blockquote>"In the middle of difficulty lies opportunity." ‚Äî Albert Einstein</blockquote>
<blockquote>"La vie est un myst√®re qu'il faut vivre, et non un probl√®me √† r√©soudre." ‚Äî Gandhi</blockquote>
</div>

<!-- Chat flottant -->
<div id="chatToggle">üí¨</div>

<div id="chatContainer">
<div id="chatHeader">
<span>Chat</span>
<button id="logoutBtn">Se d√©connecter</button>
</div>
<div id="messages"></div>
<input type="text" id="newMessage" placeholder="Tapez votre message">
<button id="sendBtn">Envoyer</button>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { collection, addDoc, query, orderBy, onSnapshot, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const loginDiv=document.getElementById("loginDiv");
const quotesDiv=document.getElementById("quotesDiv");
const emailInput=document.getElementById("email");
const passwordInput=document.getElementById("password");
const loginBtn=document.getElementById("loginBtn");
const signupBtn=document.getElementById("signupBtn");
const errorMsg=document.getElementById("errorMsg");
const logoutBtn=document.getElementById("logoutBtn");

const messagesDiv=document.getElementById("messages");
const newMessageInput=document.getElementById("newMessage");
const sendBtn=document.getElementById("sendBtn");

const sidebar=document.getElementById("sidebar");
const usersListDiv=document.getElementById("usersList");

const chatToggle=document.getElementById("chatToggle");
const chatContainer=document.getElementById("chatContainer");

const ADMIN_EMAIL="nouredine.m22@gmail.com";
let userEmail="";
let selectedUser=null;
const messagesCollection=collection(db,"chats_messages");
const usersCollection=collection(db,"users");
const usersDivMap={};

// Connexion / inscription
loginBtn.addEventListener("click", async()=>{
errorMsg.textContent="";
const email=emailInput.value.trim();
const password=passwordInput.value;
if(!email||!password){errorMsg.textContent="Veuillez remplir tous les champs.";return;}
try{await signInWithEmailAndPassword(auth,email,password);}catch(err){errorMsg.textContent=err.message;}
});
signupBtn.addEventListener("click", async()=>{
errorMsg.textContent="";
const email=emailInput.value.trim();
const password=passwordInput.value;
if(!email||!password){errorMsg.textContent="Veuillez remplir tous les champs.";return;}
if(password.length<6){errorMsg.textContent="Le mot de passe doit contenir au moins 6 caract√®res.";return;}
try{
await createUserWithEmailAndPassword(auth,email,password);
await setDoc(doc(db,"users",email),{email:email,createdAt:serverTimestamp()});
}catch(err){errorMsg.textContent=err.message;}
});
logoutBtn.addEventListener("click",async()=>{await signOut(auth);});

// Auth state
onAuthStateChanged(auth, async(user)=>{
if(user){
loginDiv.style.display="none";
quotesDiv.style.display="block";
chatToggle.style.display="block";
userEmail=user.email;

if(userEmail===ADMIN_EMAIL){
sidebar.style.display="block";
await loadUsersForAdmin();
}else{
sidebar.style.display="none";
selectedUser=ADMIN_EMAIL;
}

loadMessages();
}else{
loginDiv.style.display="block";
quotesDiv.style.display="none";
chatContainer.style.display="none";
chatToggle.style.display="none";
userEmail="";
selectedUser=null;
}
});

// Sidebar admin
async function loadUsersForAdmin(){
const usersSnapshot=await getDocs(usersCollection);
usersListDiv.innerHTML="";
usersSnapshot.forEach(doc=>{
const email=doc.data().email;
if(email!==ADMIN_EMAIL){
const div=document.createElement("div");
div.classList.add("userItem");
div.textContent=email;
div.addEventListener("click",()=>{
document.querySelectorAll(".userItem").forEach(e=>e.classList.remove("active"));
div.classList.remove("newMessage");
div.classList.add("active");
selectedUser=email;
loadMessages();
});
usersListDiv.appendChild(div);
usersDivMap[email]=div;
}
});
}

// Charger messages
function loadMessages(){
let q=query(messagesCollection,orderBy("timestamp"));
onSnapshot(q,snapshot=>{
messagesDiv.innerHTML="";
snapshot.docChanges().forEach(change=>{
const data=change.doc.data();
if(userEmail===ADMIN_EMAIL){
if(!selectedUser) return;
if(!(data.sender===selectedUser||data.recipient===selectedUser)) return;
if(data.sender!==ADMIN_EMAIL&&data.sender!==selectedUser){
const div=usersDivMap[data.sender];
if(div) div.classList.add("newMessage");
}
}else{
if(!(data.sender===userEmail||(data.sender===ADMIN_EMAIL&&data.recipient===userEmail))) return;
}
const div=document.createElement("div");
div.classList.add("message");
div.textContent=`${data.sender}: ${data.text}`;
messagesDiv.appendChild(div);
});
messagesDiv.scrollTop=messagesDiv.scrollHeight;
});
}

// Envoyer message
sendBtn.addEventListener("click", async()=>{
const text=newMessageInput.value.trim();
if(!text||!userEmail) return;
let recipient=(userEmail===ADMIN_EMAIL)?selectedUser:ADMIN_EMAIL;
if(userEmail===ADMIN_EMAIL&&!recipient){alert("S√©lectionnez un utilisateur"); return;}
try{
await addDoc(messagesCollection,{sender:userEmail,recipient:recipient,text:text,readByUser:false,timestamp:serverTimestamp()});
newMessageInput.value="";
if(userEmail!==ADMIN_EMAIL) alert("Message envoy√© !");
}catch(err){alert("Erreur: "+err.message);}
});

// Toggle chat
chatToggle.addEventListener("click",()=>{chatContainer.style.display=(chatContainer.style.display==="none")?"flex":"none";});
</script>
</body>
</html>
