<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Citations + Chat</title>
<link rel="stylesheet" href="style.css">
<style>
  body { display: flex; font-family: sans-serif; }
  .hidden { display: none; }
  #loginDiv, #quotesDiv { padding: 20px; }
  .logout { margin-bottom: 20px; cursor: pointer; }
  #errorMsg { color: red; margin-bottom: 10px; }
  input, button { padding: 8px; margin-bottom: 10px; }
  button { cursor: pointer; }

  /* Sidebar admin */
  #sidebar { width: 200px; border-right: 1px solid #ccc; padding: 10px; }
  #sidebar h3 { margin-top: 0; }
  .userItem { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; }
  .userItem.active { background-color: #ddd; }

  /* Chat */
  #chatContainer { flex: 1; padding: 10px; }
  #messages { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-bottom: 10px; }
  .message { padding: 5px; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<!-- FORMULAIRE DE CONNEXION / INSCRIPTION -->
<div id="loginDiv">
  <h2>Connexion / Inscription</h2>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Mot de passe (≥6 caractères)" required>
  <div>
    <button id="loginBtn">Se connecter</button>
    <button id="signupBtn">S’inscrire</button>
  </div>
  <p id="errorMsg"></p>
</div>

<!-- PAGE DES CITATIONS + CHAT -->
<div id="quotesDiv" class="hidden" style="display:flex; flex:1;">
  <!-- Sidebar admin -->
  <div id="sidebar" class="hidden">
    <h3>Utilisateurs</h3>
    <div id="usersList"></div>
  </div>

  <!-- Contenu principal -->
  <div id="chatContainer">
    <button id="logoutBtn" class="logout">Se déconnecter</button>
    <h2>Citations</h2>
    <blockquote>"In the middle of difficulty lies opportunity." — Albert Einstein</blockquote>
    <blockquote>"La vie est un mystère qu'il faut vivre, et non un problème à résoudre." — Gandhi</blockquote>

    <div id="messages"></div>
    <input type="text" id="newMessage" placeholder="Tapez votre message">
    <button id="sendBtn">Envoyer</button>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { collection, addDoc, query, orderBy, onSnapshot, getDocs } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const loginDiv = document.getElementById("loginDiv");
const quotesDiv = document.getElementById("quotesDiv");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const errorMsg = document.getElementById("errorMsg");
const logoutBtn = document.getElementById("logoutBtn");

const messagesDiv = document.getElementById("messages");
const newMessageInput = document.getElementById("newMessage");
const sendBtn = document.getElementById("sendBtn");

const sidebar = document.getElementById("sidebar");
const usersListDiv = document.getElementById("usersList");

const ADMIN_EMAIL = "nouredine.m22@gmail.com";
let userEmail = "";
let selectedUser = null;

const messagesCollection = collection(db, "chats_messages");

// ------------------- Connexion/Inscription -------------------
loginBtn.addEventListener("click", async () => {
  errorMsg.textContent = "";
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) { errorMsg.textContent = "Veuillez remplir tous les champs."; return; }
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch(err) { errorMsg.textContent = err.message; }
});

signupBtn.addEventListener("click", async () => {
  errorMsg.textContent = "";
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) { errorMsg.textContent = "Veuillez remplir tous les champs."; return; }
  if (password.length < 6) { errorMsg.textContent = "Le mot de passe doit contenir au moins 6 caractères."; return; }
  try { await createUserWithEmailAndPassword(auth, email, password); }
  catch(err) { errorMsg.textContent = err.message; }
});

logoutBtn.addEventListener("click", async () => { await signOut(auth); });

// ------------------- Gestion chat -------------------
onAuthStateChanged(auth, async (user) => {
  if (user) {
    loginDiv.classList.add("hidden");
    quotesDiv.classList.remove("hidden");
    userEmail = user.email;

    // Sidebar visible seulement pour admin
    if(userEmail === ADMIN_EMAIL) sidebar.classList.remove("hidden");

    // Liste des utilisateurs pour admin
    if(userEmail === ADMIN_EMAIL) {
      const snapshot = await getDocs(messagesCollection);
      const usersSet = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.sender !== ADMIN_EMAIL) usersSet.add(data.sender);
      });
      usersListDiv.innerHTML = "";
      Array.from(usersSet).forEach(email => {
        const div = document.createElement("div");
        div.classList.add("userItem");
        div.textContent = email;
        div.addEventListener("click", () => {
          document.querySelectorAll(".userItem").forEach(e=>e.classList.remove("active"));
          div.classList.add("active");
          selectedUser = email;
          loadMessages();
        });
        usersListDiv.appendChild(div);
      });
    }

    // Messages en temps réel
    loadMessages();
  } else {
    loginDiv.classList.remove("hidden");
    quotesDiv.classList.add("hidden");
    userEmail = "";
    selectedUser = null;
  }
});

// Charger messages selon rôle
function loadMessages() {
  let q;
  if(userEmail === ADMIN_EMAIL) {
    if(!selectedUser) {
      messagesDiv.innerHTML = "<i>Sélectionnez un utilisateur pour voir les messages</i>";
      return;
    }
    q = query(messagesCollection, orderBy("timestamp"));
  } else {
    q = query(messagesCollection, orderBy("timestamp"));
  }

  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      if(userEmail === ADMIN_EMAIL) {
        // admin voit seulement messages de la conversation sélectionnée
        if(data.sender !== selectedUser && data.recipient !== selectedUser) return;
      } else {
        // utilisateur voit ses messages et réponses admin
        if(!((data.sender === userEmail) || (data.sender === ADMIN_EMAIL && data.recipient === userEmail))) return;
      }
      const div = document.createElement("div");
      div.classList.add("message");
      div.textContent = `${data.sender}: ${data.text}`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// Envoyer message
sendBtn.addEventListener("click", async () => {
  const text = newMessageInput.value.trim();
  if(!text || !userEmail) return;

  let recipientEmail;
  if(userEmail === ADMIN_EMAIL) {
    if(!selectedUser){ alert("Sélectionnez un utilisateur"); return; }
    recipientEmail = selectedUser;
  } else {
    recipientEmail = ADMIN_EMAIL;
  }

  try {
    await addDoc(messagesCollection, {
      sender: userEmail,
      recipient: recipientEmail,
      text: text,
      readByUser: false,
      timestamp: new Date()
    });
    newMessageInput.value = "";
    if(userEmail !== ADMIN_EMAIL) alert("Message envoyé !");
  } catch(err) {
    alert("Erreur : " + err.message);
  }
});
</script>
</body>
</html>
