<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Citations – Alethia</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { firebaseConfig, auth, db } from "./firebase-config.js";

    const quotesContainer = document.getElementById("quotes-container");
    const requestSection = document.getElementById("request-section");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // si non connecté, afficher formulaire de demande
        requestSection.style.display = "block";
        quotesContainer.style.display = "none";
        return;
      }

      const userEmail = user.email;
      requestSection.style.display = "none";
      quotesContainer.style.display = "block";

      // Charger les publications
      const pubCol = collection(db, "publications");
      const q = query(pubCol, orderBy("date", "desc"));
      const snapshot = await getDocs(q);
      quotesContainer.innerHTML = "";

      for (let docSnap of snapshot.docs) {
        const pub = docSnap.data();
        const article = document.createElement("article");
        article.style.marginBottom = "40px";

        let mediaHTML = "";
        if(pub.mediaType === "image") {
          const url = await getDownloadURL(ref(db, pub.mediaPath));
          mediaHTML = `<img src="${url}" style="max-width:100%; margin:10px 0;">`;
        } else if(pub.mediaType === "video") {
          const url = await getDownloadURL(ref(db, pub.mediaPath));
          mediaHTML = `<video controls style="max-width:100%; margin:10px 0;">
                         <source src="${url}" type="video/mp4">
                       </video>`;
        }

        article.innerHTML = `
          <blockquote style="font-style: italic; border-left: 3px solid #6a4e3a; padding-left: 15px;">
            ${pub.text || ""}
            ${mediaHTML}
            <br>— ${pub.author || "Admin"} – ${pub.date || "Date non précisée"}
          </blockquote>
          <div class="comments" id="comments-${docSnap.id}">
            <h4>Commentaires :</h4>
          </div>
        `;
        quotesContainer.appendChild(article);
      }
    });
  </script>
</head>
<body>
  <header>
    <h1>Citations & Réflexions</h1>
    <nav>
      <a href="index.html" class="active">Home</a>
      <a href="quotes.html">Quotes</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <main>
    <section id="quotes-section">
      <div id="quotes-container">
        <p>Chargement des citations...</p>
      </div>
    </section>

    <section id="request-section" style="display:none; text-align:center;">
      <h3>Accès aux citations</h3>
      <p>Vous devez être connecté pour accéder aux citations et au chat privé.</p>
      <a href="login.html"><button>Se connecter / Créer un compte</button></a>
    </section>
  </main>

  <footer>
    <p>© 2025 Alethia</p>
  </footer>

  <!-- Script chat -->
  <script type="module" src="chat.js"></script>
</body>
</html>
