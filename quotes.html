<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Citations – Alethia</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { firebaseConfig } from "./firebase-config.js";

    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.addEventListener("DOMContentLoaded", () => {
      const quotesContainer = document.getElementById("quotes-container");
      const chatBtn = document.getElementById("chat-btn");
      const chatWindow = document.getElementById("chat-window");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatMessages = document.getElementById("chat-messages");

      let currentUserEmail = "";

      // Vérifier si l’utilisateur est connecté
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        currentUserEmail = user.email;
        document.getElementById("user-email").textContent = currentUserEmail;

        // Charger les publications (quotes)
        await loadQuotes();
      });

      async function loadQuotes() {
        const pubCol = collection(db, "publications");
        const q = query(pubCol, orderBy("date", "desc"));
        const snapshot = await getDocs(q);
        quotesContainer.innerHTML = "";

        snapshot.forEach(docSnap => {
          const pub = docSnap.data();
          const article = document.createElement("article");
          article.style.marginBottom = "40px";

          let mediaHTML = "";
          if(pub.mediaType === "image") {
            mediaHTML = `<img src="${pub.mediaPath}" style="max-width:100%; margin:10px 0;">`;
          } else if(pub.mediaType === "video") {
            mediaHTML = `<video controls style="max-width:100%; margin:10px 0;">
                           <source src="${pub.mediaPath}" type="video/mp4">
                         </video>`;
          }

          article.innerHTML = `
            <blockquote style="font-style: italic; border-left: 3px solid #6a4e3a; padding-left: 15px;">
              ${pub.text || ""}
              ${mediaHTML}
              <br>— ${pub.author || "Admin"} – ${pub.date || "Date non précisée"}
            </blockquote>
          `;
          quotesContainer.appendChild(article);
        });
      }

      // Afficher/Masquer le chat
      chatBtn.addEventListener("click", () => {
        chatWindow.style.display = chatWindow.style.display === "block" ? "none" : "block";
      });

      // Envoyer un message
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const messageText = chatInput.value.trim();
        if (!messageText) return;

        await addDoc(collection(db, "chats"), {
          sender: currentUserEmail,
          receiver: "nouredine.m22@gmail.com",
          message: messageText,
          timestamp: new Date().toISOString()
        });

        chatInput.value = "";
        loadChatMessages();
      });

      // Charger les messages du chat
      async function loadChatMessages() {
        chatMessages.innerHTML = "";
        const chatCol = collection(db, "chats");
        const q = query(chatCol, orderBy("timestamp", "asc"));
        const snapshot = await getDocs(q);

        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          if(msg.sender === currentUserEmail || msg.receiver === currentUserEmail) {
            const p = document.createElement("p");
            p.innerHTML = `<strong>${msg.sender}:</strong> ${msg.message}`;
            chatMessages.appendChild(p);
          }
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Rafraîchir le chat toutes les 3 secondes
      setInterval(loadChatMessages, 3000);
    });

    // Déconnexion
    window.logout = () => {
      signOut(auth).then(() => window.location.href="login.html");
    };
  </script>
</head>

<body>
  <header>
    <h1>Citations & Réflexions</h1>
    <nav>
      <a href="index.html">Accueil</a>
      <a href="quotes.html" class="active">Quotes</a>
      <a href="contact.html">Contact</a>
      <span id="user-section" style="float:right;">
        Connecté en tant que <strong id="user-email"></strong> |
        <a href="#" onclick="logout()">Déconnexion</a>
      </span>
    </nav>
  </header>

  <main>
    <section id="quotes-section">
      <div id="quotes-container">
        <p>Chargement des citations...</p>
      </div>
    </section>
  </main>

  <!-- Bouton et fenêtre de chat -->
  <button id="chat-btn" style="position:fixed; bottom:20px; right:20px; padding:10px 15px; background:#6a4e3a; color:#fff; border:none; border-radius:5px; cursor:pointer;">
    Chat
  </button>

  <div id="chat-window" style="display:none; position:fixed; bottom:70px; right:20px; width:300px; max-height:400px; background:#2b211b; border:2px solid #4b3a2d; border-radius:5px; padding:10px; overflow:auto; color:#e5d6c6;">
    <div id="chat-messages" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
    <form id="chat-form">
      <input id="chat-input" type="text" placeholder="Écrire un message..." style="width:100%; padding:5px; margin-bottom:5px; background:#1a1410; color:#e5d6c6; border:1px solid #4b3a2d; border-radius:3px;">
      <button type="submit" style="width:100%; background:#4b3a2d; color:#fff; border:none; padding:5px; border-radius:3px; cursor:pointer;">Envoyer</button>
    </form>
  </div>

  <footer>
    <p>© 2025 Alethia</p>
  </footer>
</body>
</html>
