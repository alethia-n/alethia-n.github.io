<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Citations â€“ Alethia</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { firebaseConfig } from "./firebase-config.js";

    // ðŸ”¥ Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const quotesContainer = document.getElementById("quotes-container");

    // ==========================
    // ðŸ§­ Gestion de la connexion
    // ==========================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Non connectÃ© â†’ redirection
        window.location.href = "login.html";
        return;
      }

      document.getElementById("user-email").textContent = user.email;
      document.getElementById("logout-btn").style.display = "inline";

      // Charger les citations
      await loadQuotes();
    });

    // DÃ©connexion
    window.logout = () => {
      signOut(auth).then(() => (window.location.href = "login.html"));
    };

    // ==========================
    // ðŸ“œ Charger les citations
    // ==========================
    async function loadQuotes() {
      const pubCol = collection(db, "publications");
      const q = query(pubCol, orderBy("date", "desc"));
      const snapshot = await getDocs(q);

      quotesContainer.innerHTML = "";

      for (let docSnap of snapshot.docs) {
        const pub = docSnap.data();
        const article = document.createElement("article");
        article.style.marginBottom = "50px";

        let mediaHTML = "";
        if (pub.mediaType === "image") {
          const url = await getDownloadURL(ref(storage, pub.mediaPath));
          mediaHTML = `<img src="${url}" style="max-width:100%; margin:10px 0; border-radius:6px;">`;
        } else if (pub.mediaType === "video") {
          const url = await getDownloadURL(ref(storage, pub.mediaPath));
          mediaHTML = `
            <video controls style="max-width:100%; margin:10px 0; border-radius:6px;">
              <source src="${url}" type="video/mp4">
            </video>`;
        }

        article.innerHTML = `
          <blockquote style="font-style: italic; border-left: 3px solid #6a4e3a; padding-left: 15px;">
            ${pub.text || ""}
            ${mediaHTML}
            <br>â€” ${pub.author || "Anonyme"} â€“ ${pub.date || "Date non prÃ©cisÃ©e"}
          </blockquote>
        `;

        quotesContainer.appendChild(article);
      }
    }
  </script>
</head>

<body>
  <header>
    <h1>Citations & RÃ©flexions</h1>
    <nav>
      <a href="index.html">Accueil</a>
      <a href="quotes.html" class="active">Citations</a>
      <a href="contact.html">Contact</a>
      <span style="float:right;">
        <span id="user-email"></span>
        <button id="logout-btn" onclick="logout()" style="display:none; background:none; border:none; color:#d6bfa9; cursor:pointer;">DÃ©connexion</button>
      </span>
    </nav>
  </header>

  <main>
    <section id="quotes-section">
      <div id="quotes-container">
        <p>Chargement des citations...</p>
      </div>
    </section>
  </main>

  <footer>
    <p>Â© 2025 Alethia â€“ Tous droits rÃ©servÃ©s</p>
  </footer>

  <!-- ðŸ’¬ Chat privÃ© (visible seulement si connectÃ©) -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Ã‰crivez votre message..." />
      <button type="submit">Envoyer</button>
    </form>
  </div>

  <!-- Chat module -->
  <script type="module" src="chat.js"></script>
</body>
</html>
