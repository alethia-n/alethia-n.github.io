<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Citations â€“ Alethia</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ðŸ’¬ Style du chat flottant */
    #chat-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background: #2b211b;
      border: 1px solid #4b3a2d;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }
    #chat-header {
      background: #4b3a2d;
      color: #e5d6c6;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
    }
    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      max-height: 200px;
    }
    #chat-messages p {
      margin: 5px 0;
      padding: 5px 8px;
      background: #3a2c24;
      border-radius: 5px;
      font-size: 0.9em;
    }
    #chat-form {
      display: flex;
      border-top: 1px solid #4b3a2d;
    }
    #chat-form input {
      flex: 1;
      border: none;
      padding: 8px;
      background: #2b211b;
      color: #e5d6c6;
    }
    #chat-form button {
      background: #4b3a2d;
      border: none;
      color: #e5d6c6;
      padding: 8px 12px;
      cursor: pointer;
    }
    #chat-form button:hover {
      background: #6a4e3a;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    // === Initialisation Firebase ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const chatMessages = document.getElementById("chat-messages");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    // === Authentification requise ===
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Veuillez vous connecter pour accÃ©der au chat des citations.");
        window.location.href = "login.html";
        return;
      }

      // Ã‰coute en temps rÃ©el des messages
      const messagesRef = collection(db, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        chatMessages.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const p = document.createElement("p");
          p.textContent = `${msg.email}: ${msg.text}`;
          chatMessages.appendChild(p);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      // Envoi dâ€™un message
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (chatInput.value.trim() === "") return;

        await addDoc(messagesRef, {
          uid: user.uid,
          email: user.email,
          text: chatInput.value.trim(),
          timestamp: serverTimestamp()
        });

        chatInput.value = "";
      });
    });
  </script>
</head>
<body>
  <header>
    <h1>Citations & RÃ©flexions</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="quotes.html" class="active">Quotes</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>RÃ©flexions et pensÃ©es partagÃ©es</h2>
      <p>Bienvenue dans lâ€™espace des citations. Connectez-vous pour participer au chat et partager vos pensÃ©es.</p>
    </section>
  </main>

  <!-- ðŸ’¬ Chat flottant -->
  <div id="chat-box">
    <div id="chat-header">Chat â€“ Alethia</div>
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Ã‰crire un message..." autocomplete="off" />
      <button type="submit">Envoyer</button>
    </form>
  </div>

  <footer>
    <p>Â© 2019 Alethia</p>
  </footer>
</body>
</html>
